<html>
<head>

<script type="text/javascript" src="js/prototype.js"></script>
<script type="text/javascript" src="fx/flapjax.js"></script>

<title>Flapjax Demo: Wanderling Letters</title>

<script type="text/javascript">

function loader() {

  var TextFieldWidth = 300;
  var TextFieldHeight = 300;
  var ary = 'Hello'.split('');

  var posXArray = new Array(5);
  var posYArray = new Array(5);

  // Random Placement

  for (i = 0; i < 5; i++) {
    insertDomB(
      DIV({style: { position: 'absolute',
                    left: posXArray[i] = Math.random() * TextFieldWidth,
                    top: posYArray[i] = Math.random() * TextFieldHeight }, id: 'p' + i},
          ary[i]),
      'p' + i);
  }

  // rightB :: Element -> Behavior cumulative position of right edge
  function rightB(t_) {
    var t = $(t_); // adds Prototype methods
    var f = function() {
      var size = t.getDimensions();
      return parseFloat(t.style.getPropertyValue('left')) + size.width;
    };
    return $E(t, "DOMAttrModified")
     .filterE(function(x) { return x.attrName == "style";})
     .mapE(f)
     .startsWith(f());
  }

  function leftB(t_) {
    var t = $(t_); // adds Prototype methods
    var f = function() {
      return parseFloat(t.style.getPropertyValue('left'));
    };
    return $E(t, "DOMAttrModified")
     .filterE(function(x) { return x.attrName == "style";})
     .mapE(f)
     .startsWith(f());
  }

  function topB(t_) {
    var t = $(t_);
    var f = function() {
      var size = t.getDimensions();
      return parseFloat(t.style.getPropertyValue('top'));
    };
    return $E(t, "DOMAttrModified")
     .filterE(function(x) { return x.attrName == "style";})
     .mapE(f)
     .startsWith(f());
  }

  // Make a timer and pos0B that starts from 0 and ten pixels toward right for
  // each seconds.

  // Figure out the initial condition of the first value.
  var t = timerB(1000);
  var start = valueNow(t);
  var elapsedTimeB = t.liftB(function(x) {return x - start});

  function nextPosX(elapsedTime, targetX, targetY, curX, curY) {
    var diffX = targetX - curX;
    var diffY = targetY - curY;
    var norm = Math.sqrt(diffX * diffX + diffY * diffY);
    var speed = Math.min(norm, 13);
    var speedX = (diffX/norm) * speed;
    return curX + speedX;
  };
  function nextPosY(elapsedTime, targetX, targetY, curX, curY) {
    var diffX = targetX - curX;
    var diffY = targetY - curY;
    var norm = Math.sqrt(diffX * diffX + diffY * diffY);
    var speed = Math.min(norm, 13);
    var speedY = (diffY/norm) * speed;
    return curY + speedY;
  };

  var delayedLeftB = leftB('p0').delayB(1000);
  var delayedTopB = topB('p0').delayB(1000);

  posXArray[0] = elapsedTimeB.liftB(nextPosX, constantB(0), constantB(0), delayedLeftB, delayedTopB);
  posXArray[0] = elapsedTimeB.liftB(nextPosY, constantB(0), constantB(0), delayedLeftB, delayedTopB);

  insertDomB(
    DIV({style: { position: 'absolute',
                  left: posXArray[0],
                  top: posYArray[0] }, id: 'p0'},
        ary[0]),
    'p' + 0);

  insertDomB(
    leftB('p0'),
    'log');

//  for (i = 1; i < 5; i++) {
//    id = 'p' + i;
//    prevId = 'p' + (i-1);
//    insertDomB(
//      DIV({style: { position: 'absolute',
//                    left: delayB(rightB(prevId), 300),
//                    top: topB(prevId) }, id: id},
//          ary[i]),
//      id);
//  }
}
</script>
</head>
<body onload="loader()">
<span id="p0">H</span>
<span id="p1">e</span>
<span id="p2">l</span>
<span id="p3">l</span>
<span id="p4">o</span>
<span id="log">log</span>
</body>
</html>

