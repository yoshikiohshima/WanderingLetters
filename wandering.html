<html>
<head>

<script type="text/javascript" src="js/prototype.js"></script>
<script type="text/javascript" src="fx/flapjax.js"></script>

<title>Flapjax Demo: Wanderling Letters</title>

<script type="text/javascript">

function loader() {

  var sp = $('space').getDimensions().width;

  var ary = 'He llo He llo He llo He llo Ho Ho Ho Ho Ho HoHo Ho HoHo Ho HoHo Ho HoHo Ho HoHo Ho HoHo Ho HoHo Ho HoHo Ho Ho'.split('');

  str = '';
  for (i = 0; i < ary.length; i++) {
    str = str + '<span id=p' + i + '>' + ary[i] + '</span>';
  }
  document.body.innerHTML = str;

  // Figure out the initial condition of the first value.
  elapsedTimeB = (function (x) {
    var t = timerB(100);
    var start = valueNow(t);
    return t.liftB(function(x) {return x - start})})();

  function isSpace(t_) {
    return $(t_).firstChild.nodeValue == ' ';
  }

  function place(index, pos) {
    var me = $('p' + index);
    var prev = index == 0 ? null : $('p' + (index - 1));
    var prevSettled = prev == null ? true : pos.settled;
    if (!prevSettled) {
       me.b = false;
    }
    var targetX = prev == null ? 0 : (me.b ? 0 : pos.r);
    var targetY = prev == null ? 0 : (me.b ? pos.y + me.getDimensions().height : pos.y);
    var curX = parseFloat(me.style.getPropertyValue('left'));
    var curY = parseFloat(me.style.getPropertyValue('top'));

    var diffX = targetX - curX;
    var diffY = targetY - curY;
    var norm = Math.sqrt(diffX * diffX + diffY * diffY);
    if (norm < 13) {
      var newRight = targetX + me.getDimensions().width;
      if (newRight > TextFieldWidth && prevSettled) {
        me.b = true;
        return {x: targetX, y: targetY + me.getDimensions().height, r: me.getDimensions().width, settled: false};
      } else {
        return {x: targetX, y: targetY, r: targetX + (isSpace(me) ? sp : me.getDimensions().width), settled: true};
      }
    }
    var speed = Math.min(norm, 13);
    var speedX = (diffX/norm) * speed;
    var speedY = (diffY/norm) * speed;
    var jit = prev == null ? 0 : Math.random() * 6 - 3;
    return {x: curX + speedX, y: curY + speedY + jit, r: curX + speedX + (isSpace(me) ? sp : me.getDimensions().width), settled: false};
  };


  function placeFirst() {
    return place(0, {x: 0, y: 0, r: 0});
  };

  var TextFieldWidth = 300;
  var TextFieldHeight = 300;

  var posArray = new Array(ary.length);
  var rightArray = new Array(ary.length);

  for (i = 0; i < ary.length; i++) {
    var f = (function() {
      var ii = i;
      if (ii == 0) {
        return function (time) {
          return placeFirst();
        }
      } else {
        return function (pos) {
          return place(ii, pos);
        }
      }
    })();
    posArray[i] = (i == 0 ? elapsedTimeB : posArray[i-1])
                     .changes()
                     .mapE(f)
                     .startsWith({x: Math.random() * TextFieldWidth, y: Math.random() * TextFieldHeight, r: 0, settled: false});
    insertDomB(
      DIV({style: { position: 'absolute',
                    left: posArray[i].liftB(function(x) {return x.x;}),
                    top: posArray[i].liftB(function(y) {return y.y;}) }, id: 'p' + i, b: false},
          ary[i]),
      'p' + i);
  }
}
</script>
</head>
<body onload="loader()">
<span id='space'>x</span>
</body>
</html>

